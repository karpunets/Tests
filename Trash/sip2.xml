<?xml version="1.0" encoding="ISO-8859-1" ?>
<!DOCTYPE scenario SYSTEM "sipp.dtd">
<scenario name="UAC with media">
    <!-- wait for the command from the 1st SIPp instance and parse the message creating the $callid, $localtag end $remotetag vars-->
    <recvCmd>
        <action>
            <ereg regexp="Call-ID: new_([^\r]+)\r" search_in="msg" assign_to="1,callid" check_it="true"/>
            <!--<ereg regexp="Local-tag: ([^\r]+)\r" search_in="msg" assign_to="1,localtag" check_it="true"/>-->
            <!--<ereg regexp="Remote-tag: ;tag=([^\r]+)\r" search_in="msg" assign_to="1,remotetag" check_it="true"/>-->
            <log message="Call-ID: [$callid]"/>
            <!--<log message="Local-tag: [$localtag]"/>-->
            <!--<log message="Remote-tag: [$remotetag]"/>-->
            <!-- just log the [$1] otherwise SIPp complains that $1 isn't used -->
            <log message="=======\nAll: [$1]\n======="/>
        </action>
    </recvCmd>

  <nop display="Received command"/>
  <!-- send INVITE containing the Replaces header-->
  <send>
        <![CDATA[
          INVITE sip:[service]@[remote_ip]:[remote_port] SIP/2.0
          Via: SIP/2.0/[transport] [local_ip]:[local_port];branch=[branch]
          From: <sip:3399222@[local_ip];[field1];x-refci=[field0];x-nearendclusterid=StandAloneCluster;x-nearenddevice=54ee754a879e;x-nearendaddr=3399222;x-farendrefci=25410701;x-farendclusterid=StandAloneCluster;x-farenddevice=[field2];x-farendaddr=1056>;tag=[call_number]~f643f5b4-6431-42a7-b82c-b7175b6c3219-28913122
          To: <sip:[service]@[remote_ip]>
          Call-ID: [call_id]
          Date: Mon, 18 Dec 2017 21 GMT
          Supported: timer,resource-priority,replaces,X-cisco-srtp-fallback,Geolocation
          Min-SE: 1800
          User-Agent: Cisco-CUCM10.5
          Allow: INVITE,OPTIONS,INFO,BYE,CANCEL,ACK,PRACK,UPDATE,REFER,SUBSCRIBE,NOTIFY
          CSeq: 101 INVITE
          Expires: 180
          Allow-Events: presence,kpml
          Call-Info:  <sip:[local_ip]:[local_port]>;method="NOTIFY;Event=telephone-event;Duration=500"
          Cisco-Guid: 4062038400-0000065536-0000000075-0201463468
          Session-Expires: 1800
          P-Asserted-Identity: <sip:3399222@[local_ip]>
          Remote-Party-ID: <sip:3399222@[local_ip]>;party=calling;screen=yes;privacy=off
          Contact: <sip:3399222@[local_ip]:[local_port];transport=[transport]>;isFocus
          Max-Forwards: 70
          Content-Length: 0
          ]]>
  </send>

  <recv response="180" optional="true">
    </recv>


  <recv response="200" crlf="true" rrs="true">
    </recv>


  <send>
      <![CDATA[ACK sip:[remote_ip]:[remote_port];transport=[transport] SIP/2.0
        Via: SIP/2.0/[transport] [local_ip]:[local_port];branch=[branch]
        From: <sip:3399222@[local_ip];[field1];x-refci=[field0];x-nearendclusterid=StandAloneCluster;x-nearenddevice=54ee754a879e;x-nearendaddr=3399222;x-farendrefci=25410701;x-farendclusterid=StandAloneCluster;x-farenddevice=[field2];x-farendaddr=1056>;tag=[call_number]~f643f5b4-6431-42a7-b82c-b7175b6c3219-28913122
        To: <sip:[service]@[remote_ip]:[remote_port]>[peer_tag_param]
        Call-ID: [call_id]
        User-Agent: Cisco-CUCM10.5
        CSeq: 101 ACK
        Allow-Events: presence, kpml
        Contact: sip:3399222@[local_ip]:[local_port]
        Max-Forwards: 70
        Subject: Performance Test
        Content-Type: application/sdp
        Content-Length: [len]

        v=0
        o=CiscoSystemsCCM-SIP 63811 1 IN IP[local_ip_type] [local_ip]
        s=SIP Call
        c=IN IP[local_ip_type] [local_ip]
        b=TIAS:64000
        b=CT:64
        b=AS:64
        t=0 0
        m=audio [auto_media_port] RTP/AVP 0 101
        a=ptime:20
        a=rtpmap:0 PCMU/8000
        a=sendonly
        a=rtpmap:101 telephone-event/8000
        a=fmtp:101 0-15
      ]]>
    </send>

    <!-- Play a pre-recorded PCAP file (RTP stream)                       -->
    <nop>
      <action>
        <exec play_pcap_audio="pcap/second.pcap"/>
      </action>
    </nop>

    <!-- Pause 8 seconds, which is approximately the duration of the      -->
    <!-- PCAP file                                                        -->
    <pause milliseconds="13500"/>


   <!-- The 'crlf' option inserts a blank line in the statistics report. -->
  <send crlf="true">
      <![CDATA[
        BYE sip:[remote_ip]:[remote_port];transport=[transport] SIP/2.0
        Via: SIP/2.0/[transport] [local_ip]:[local_port];branch=[branch]
        From: <sip:3399222@[local_ip];[field1];x-refci=[field0];x-nearendclusterid=StandAloneCluster;x-nearenddevice=54ee754a879e;x-nearendaddr=3399222;x-farendrefci=25410701;x-farendclusterid=StandAloneCluster;x-farenddevice=[field2];x-farendaddr=1056>;tag=[call_number]~f643f5b4-6431-42a7-b82c-b7175b6c3219-28913122
        To: <sip:[service]@[remote_ip]>[peer_tag_param]
        Call-ID: [call_id]
        User-Agent: Cisco-CUCM10.5
        CSeq: 102 BYE
        Max-Forwards: 70
        P-Asserted-Identity: <sip:3399222@[local_ip]>
        Content-Length: 0
      ]]>
    </send>

   <recv response="200" crlf="true">
   </recv>
  <!-- definition of the response time repartition table (unit is ms)   -->
  <ResponseTimeRepartition value="10, 20, 30, 40, 50, 100, 150, 200"/>
  <!-- definition of the call length repartition table (unit is ms)     -->
  <CallLengthRepartition value="10, 50, 100, 500, 1000, 5000, 10000"/>

</scenario>